<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      background-color: #f4f7f9;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 2em;
      color: #007bff;
    }

    #auth-container {
      display: flex;
      gap: 10px;
    }

    #task-container {
      display: none;
    }

    .task-list {
      list-style: none;
      padding: 0;
    }

    .task-item {
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-item .details {
      flex-grow: 1;
    }

    .task-item .actions {
      display: flex;
      gap: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #0056b3;
    }

    .delete-btn {
      background-color: #dc3545;
    }

    .delete-btn:hover {
      background-color: #c82333;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Task Manager</h1>
      <div id="auth-container">
        <button id="login-btn">Login</button>
        <button id="register-btn">Register</button>
      </div>
      <div id="user-container" style="display: none;">
        <span id="user-greeting"></span>
        <button id="logout-btn">Logout</button>
      </div>
    </header>

    <main>
      <div id="login-register-forms">
        <!-- Login and Register forms will be dynamically shown/hidden -->
      </div>

      <div id="task-container">
        <button id="add-task-btn"><i class="fas fa-plus"></i> Add Task</button>
        <ul id="task-list" class="task-list"></ul>
      </div>
    </main>
  </div>

  <!-- Modals -->
  <div id="auth-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="auth-modal-title"></h2>
      <form id="auth-form">
        <input type="text" id="name" placeholder="Name (for registration)">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit" id="auth-submit-btn"></button>
      </form>
    </div>
  </div>

  <div id="task-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="task-modal-title"></h2>
      <form id="task-form">
        <input type="hidden" id="task-id">
        <input type="hidden" id="task-version">
        <input type="text" id="task-title" placeholder="Task Title" required>
        <textarea id="task-description" placeholder="Task Description" rows="4" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;"></textarea>
        <select id="task-priority">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
        <input type="date" id="task-due-date" required>
        <select id="task-status">
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
        </select>
        <button type="submit" id="task-submit-btn"></button>
      </form>
    </div>
  </div>

  <script>
    const TASK_MANAGER_API = 'http://localhost:3000/v1';
    let AUTH_TOKEN = null;

    // DOM Elements
    const authContainer = document.getElementById('auth-container');
    const userContainer = document.getElementById('user-container');
    const userGreeting = document.getElementById('user-greeting');
    const taskContainer = document.getElementById('task-container');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const addTaskBtn = document.getElementById('add-task-btn');
    const taskList = document.getElementById('task-list');

    // Modals
    const authModal = document.getElementById('auth-modal');
    const taskModal = document.getElementById('task-modal');
    const authForm = document.getElementById('auth-form');
    const taskForm = document.getElementById('task-form');

    // --- Event Listeners ---

    loginBtn.addEventListener('click', () => openAuthModal('Login'));
    registerBtn.addEventListener('click', () => openAuthModal('Register'));
    logoutBtn.addEventListener('click', logout);
    addTaskBtn.addEventListener('click', () => openTaskModal());

    authModal.querySelector('.close').addEventListener('click', () => authModal.style.display = 'none');
    taskModal.querySelector('.close').addEventListener('click', () => taskModal.style.display = 'none');
    window.addEventListener('click', (event) => {
      if (event.target == authModal) authModal.style.display = 'none';
      if (event.target == taskModal) taskModal.style.display = 'none';
    });

    authForm.addEventListener('submit', handleAuthFormSubmit);
    taskForm.addEventListener('submit', handleTaskFormSubmit);

    // --- Auth Functions ---

    function openAuthModal(type) {
      const title = document.getElementById('auth-modal-title');
      const submitBtn = document.getElementById('auth-submit-btn');
      const nameField = document.getElementById('name');

      title.textContent = type;
      submitBtn.textContent = type;
      nameField.style.display = type === 'Register' ? 'block' : 'none';
      authForm.dataset.type = type;
      authModal.style.display = 'block';
    }

    async function handleAuthFormSubmit(event) {
      event.preventDefault();
      const type = event.target.dataset.type;
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const url = type === 'Register' ? `${TASK_MANAGER_API}/auth/register` : `${TASK_MANAGER_API}/auth/login`;
      const body = type === 'Register' ? { name, email, password } : { email, password };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok) {
          if (type === 'Login') {
            AUTH_TOKEN = data.token;
            userGreeting.textContent = `Welcome, ${data.name}`;
            showTaskView();
          } else {
            alert('Registration successful! Please log in.');
          }
          authModal.style.display = 'none';
          authForm.reset();
        } else {
          alert(data.message);
        }
      } catch (error) {
        alert('An error occurred. Please try again.');
      }
    }

    function logout() {
      AUTH_TOKEN = null;
      showLoginView();
    }

    // --- Task Functions ---

    function openTaskModal(task = null) {
      const title = document.getElementById('task-modal-title');
      const submitBtn = document.getElementById('task-submit-btn');
      const taskIdField = document.getElementById('task-id');
      const taskVersionField = document.getElementById('task-version');

      if (task) {
        title.textContent = 'Edit Task';
        submitBtn.textContent = 'Update Task';
        taskIdField.value = task.task_id;
        taskVersionField.value = task.version;
        document.getElementById('task-title').value = task.title;
        document.getElementById('task-description').value = task.description;
        document.getElementById('task-priority').value = task.priority;
        document.getElementById('task-due-date').value = task.due_date ? new Date(task.due_date).toISOString().split('T')[0] : '';
        document.getElementById('task-status').value = task.status;
      } else {
        title.textContent = 'Add Task';
        submitBtn.textContent = 'Add Task';
        taskForm.reset();
      }
      taskModal.style.display = 'block';
    }

    async function handleTaskFormSubmit(event) {
      event.preventDefault();
      const id = document.getElementById('task-id').value;
      const version = document.getElementById('task-version').value;
      const title = document.getElementById('task-title').value;
      const description = document.getElementById('task-description').value;
      const priority = document.getElementById('task-priority').value;
      const due_date = document.getElementById('task-due-date').value;
      const status = document.getElementById('task-status').value;

      const isNewTask = !id;
      const url = isNewTask ? `${TASK_MANAGER_API}/tasks` : `${TASK_MANAGER_API}/tasks/${id}`;
      const method = isNewTask ? 'POST' : 'PATCH';
      const body = { title, description, priority, due_date, status, version };

      try {
        const response = await fetch(url, {
          method,
          headers: getAuthHeaders(),
          body: JSON.stringify(body)
        });

        if (response.ok) {
          taskModal.style.display = 'none';
          loadTasks();
        } else {
            const data = await response.json();
            if (response.status === 409) {
                alert(data.message);
                loadTasks();
            } else {
                alert(data.message);
            }
        }
      } catch (error) {
        alert('An error occurred. Please try again.');
      }
    }

    async function loadTasks() {
      try {
        const response = await fetch(`${TASK_MANAGER_API}/tasks`, { headers: getAuthHeaders() });
        const data = await response.json();
        renderTasks(data.tasks);
      } catch (error) {
        alert('Failed to load tasks.');
      }
    }

    function renderTasks(tasks) {
      taskList.innerHTML = '';
      if (!tasks || tasks.length === 0) {
        taskList.innerHTML = '<p>No tasks found. Add one to get started!</p>';
        return;
      }
      tasks.forEach(task => {
        const item = document.createElement('li');
        item.className = 'task-item';
        item.innerHTML = `
          <div class="details">
            <h3>${task.title}</h3>
            <p>${task.description || ''}</p>
            <p>Priority: ${task.priority} | Status: ${task.status} | Due: ${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'N/A'}</p>
          </div>
          <div class="actions">
            <button onclick='openTaskModal(${JSON.stringify(task)})'><i class="fas fa-edit"></i></button>
            <button class="delete-btn" onclick="deleteTask('${task.task_id}')"><i class="fas fa-trash"></i></button>
          </div>
        `;
        taskList.appendChild(item);
      });
    }

    async function deleteTask(id) {
        if (!confirm('Are you sure you want to delete this task?')) return;
        try {
            const response = await fetch(`${TASK_MANAGER_API}/tasks/${id}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
            });
            if (response.ok) {
            loadTasks();
            } else {
            alert('Failed to delete task.');
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    }


    // --- UI View Management ---

    function showLoginView() {
      authContainer.style.display = 'flex';
      userContainer.style.display = 'none';
      taskContainer.style.display = 'none';
      document.getElementById('login-register-forms').style.display = 'block';
    }



    function showTaskView() {
      authContainer.style.display = 'none';
      userContainer.style.display = 'block';
      taskContainer.style.display = 'block';
      document.getElementById('login-register-forms').style.display = 'none';
      loadTasks();
    }

    function getAuthHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`
      };
    }

    // --- Initial Load ---
    showLoginView();

  </script>
</body>

</html>